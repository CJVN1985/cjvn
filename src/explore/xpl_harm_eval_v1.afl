/* CJVN – HARMONIC EVALUATION EXPLORE v1
   Một dòng = MỘT SỰ KIỆN hoàn tất harmonic (bullish/bearish).
   Ghi: ratios, PRZ, entry/SL/TP, kết quả Win@1R/2R, MFE/MAE trong N bar.
*/

SetBarsRequired(10000, 0);
SetOption("NoDefaultColumns", True);

/* ==== cần các API từ ind_harmonic_core.afl ====
   cjvn_harm_hasPattern(), cjvn_harm_lastPatternId(), cjvn_harm_direction(),
   cjvn_harm_prz_low(), cjvn_harm_prz_high(), cjvn_harm_completionBar(),
   cjvn_harm_ratio_ab_xa(), cjvn_harm_ratio_bc_ab(), cjvn_harm_ratio_cd_bc(), cjvn_harm_ratio_ad_xa(),
   cjvn_harm_dev_ab(), cjvn_harm_dev_bc(), cjvn_harm_dev_cd(), cjvn_harm_dev_ad(), cjvn_harm_confluence_cnt()
*/
#include "..\indicators\ind_harmonic_core.afl"

// === context optional ===
#include "..\indicators\ind_bb.afl"
#include "..\indicators\ind_keltner.afl"
#include "..\indicators\ind_psar.afl"
#include "..\indicators\ind_rsi_ma_zl.afl"
#include "..\indicators\ind_fibo.afl"

/* ==== PARAMS ==== */
N_eval   = Param("N bars evaluate", 20, 5, 200, 1);
useClose = ParamToggle("Entry=Close(confirm) ?", "PRZ Mid|Close", 0); // 0: dùng PRZ Mid; 1: Close hiện tại
decP     = Param("Decimals", 2, 0, 6, 1);

// ==== sự kiện hoàn tất ====
has  = cjvn_harm_hasPattern();
pid  = cjvn_harm_lastPatternId();
dir  = cjvn_harm_direction();     // 1 bull, -1 bear
przL = cjvn_harm_prz_low();
przH = cjvn_harm_prz_high();
mid  = (przL + przH)/2;
width= przH - przL;
widthPct = IIf(C != 0, 100*width/C, Null);

// ratios & devs
ab_xa = cjvn_harm_ratio_ab_xa();
bc_ab = cjvn_harm_ratio_bc_ab();
cd_bc = cjvn_harm_ratio_cd_bc();
ad_xa = cjvn_harm_ratio_ad_xa();

d_ab = cjvn_harm_dev_ab();
d_bc = cjvn_harm_dev_bc();
d_cd = cjvn_harm_dev_cd();
d_ad = cjvn_harm_dev_ad();
conf = cjvn_harm_confluence_cnt();

// ==== entry/SL/TP ====
entry = IIf(useClose, C, mid);
stop  = IIf(dir == 1, przL, przH);
risk  = Abs(entry - stop);
sign  = IIf(dir==1, 1, -1);

tp1   = entry + sign * 1.0 * risk;
tp2   = entry + sign * 2.0 * risk;

// ==== kết quả sau N bar (tính “tương lai”) ====
HiF = HHV( Ref(H, 1), N_eval );   // max high trong 1..N
LoF = LLV( Ref(L, 1), N_eval );   // min low  trong 1..N

// check hit TP / SL (bull: ưu tiên TP nếu đạt trước SL; bear ngược dấu)
hitTP1 = IIf(dir==1, HiF >= tp1, LoF <= tp1);
hitTP2 = IIf(dir==1, HiF >= tp2, LoF <= tp2);
hitSL  = IIf(dir==1, LoF <= stop, HiF >= stop);

// MFE/MAE (đơn vị R)
mfeR = IIf(risk>0,
    IIf(dir==1, (HiF - entry)/risk, (entry - LoF)/risk),
    Null);
maeR = IIf(risk>0,
    IIf(dir==1, (entry - LoF)/risk, (HiF - entry)/risk),
    Null);

// ==== ngữ cảnh nhanh ====
trendUp   = EMA(C,21) > EMA(C,55);
bbInsideKC = (ind_bb_upper < ind_kc_upper AND ind_bb_lower > ind_kc_lower);
psUp      = ind_psar_dir == 1;

// ==== Lọc ra chỉ khi mới hoàn tất (event bar) ====
// Giả sử core đặt cjvn_harm_completionBar() = 1 tại đúng bar hoàn tất:
completeNow = Nz( cjvn_harm_completionBar(), 0 );

Filter = completeNow == 1;

// ==== CỘT BẢNG ====
AddTextColumn(Name(), "Symbol", 1.0, colorDefault, colorDefault, 60);
AddColumn( DateTime(), "DateTime", formatDateTime );

AddColumn( dir, "Dir(1/-1)", 1.0 );
AddColumn( pid, "PatternId", 1.0 );

AddColumn( przL, "PRZ_L", 1.0+decP/10.0 );
AddColumn( przH, "PRZ_H", 1.0+decP/10.0 );
AddColumn( mid,  "PRZ_Mid", 1.0+decP/10.0 );
AddColumn( widthPct, "PRZ_width_%", 1.2 );

AddColumn( ab_xa, "AB/XA", 1.3 );
AddColumn( bc_ab, "BC/AB", 1.3 );
AddColumn( cd_bc, "CD/BC", 1.3 );
AddColumn( ad_xa, "AD/XA", 1.3 );
AddColumn( conf,  "Confluence", 1.0 );

AddColumn( d_ab, "dev_AB", 1.3 );
AddColumn( d_bc, "dev_BC", 1.3 );
AddColumn( d_cd, "dev_CD", 1.3 );
AddColumn( d_ad, "dev_AD", 1.3 );

AddColumn( entry, "Entry", 1.0+decP/10.0 );
AddColumn( stop,  "Stop",  1.0+decP/10.0 );
AddColumn( risk,  "Risk",  1.0+decP/10.0 );
AddColumn( tp1,   "TP1(1R)", 1.0+decP/10.0 );
AddColumn( tp2,   "TP2(2R)", 1.0+decP/10.0 );

AddColumn( hitTP1, "HitTP1", 1.0 );
AddColumn( hitTP2, "HitTP2", 1.0 );
AddColumn( hitSL,  "HitSL",  1.0 );
AddColumn( mfeR,   "MFE_R",  1.2 );
AddColumn( maeR,   "MAE_R",  1.2 );

// context
AddColumn( SelectedValue(ind_rsi_ma), "RSI_ma", 1.2 );
AddColumn( trendUp, "TrendUp", 1.0 );
AddColumn( bbInsideKC, "BB_in_KC", 1.0 );
AddColumn( psUp, "PSAR_Long", 1.0 );
